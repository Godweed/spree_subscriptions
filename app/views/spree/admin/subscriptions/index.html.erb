<% content_for :page_title do %>
  <%= t(:listing_subscriptions) %>
<% end %>

<% content_for :table_filter_title do %>
  <%= Spree.t(:search) %>
<% end %>

<% content_for :table_filter do %>
  <div data-hook="admin_subscriptions_index_search">
    <%= search_form_for [:admin, @search] do |f| %>
      <div class="four columns alpha">
        <div class="field">
          <%= label_tag :q_user_email_cont, Spree.t(:email) %>
          <%= f.text_field :user_email_cont, tabindex: 1 %>
        </div>
      </div>

      <div class="four columns">
        <div class="field">
          <%= label_tag :q_orders_number_cont, Spree.t(:order_number) %>
          <%= f.text_field :orders_number_cont, tabindex: 1 %>
        </div>
      </div>      

      <div class="clearfix"></div>

      <div class="actions filter-actions">
        <div data-hook="admin_promotions_index_search_buttons">
          <%= button Spree.t(:filter_results), 'search' %>
        </div>
      </div>
    <% end %>
  </div>
<% end %>

<% unless @subscriptions.empty? %>
  <table class="index responsive" id="listing_subscriptions" data-hook width="100%">
    <colgroup>
       <col style="width: 5%;">
       <col style="width: 10%;">
       <col style="width: 25%;">
       <col style="width: 10%;">
       <col style="width: 23%;">
       <col style="width: 12%;">
       <col style="width: 3%;">
       <col style="width: 9%;">
       <col style="width: 9%;">
       <col style="width: 9%;">
    </colgroup>
    <thead>
      <tr data-hook="admin_subscriptions_index_headers">
        <th>ID</th>
        <th>State</th>
        <th>Products</th>
        <th>Frequency</th>
        <th>Last Order</th>
        <th>Order State</th>
        <th>Skip</th>
        <th>Renew Date</th>
        <th>Est. Arrival</th>
        <th>Cancelled</th>
        <th data-hook="admin_subscriptions_index_header_actions" class="actions"></th>
      </tr>
    </thead>
    <tbody>
    <% @subscriptions.each do |subscription| %>
      <tr data-hook="admin_subscriptions_index_rows" class="<%= cycle('odd', 'even') %>">
        <td class="align-center"><%= subscription.id %></td>
        <td class="align-center">
            <span class="state <%= subscription.active? ? 'success' : 'canceled' %>"><%= subscription.state %></span>
        </td>
        <td>
            <% subscription.subscription_items.each do |item|  %>
            <%= item.variant.product.name %> <br/>
            <%= "(#{item.variant.options_text})" unless item.variant.option_values.empty? %>
            <br/>
            Qty: <%= item.quantity %>
            <% end %>
        </td>
        <td class="align-center">Every  <%= pluralize(subscription.interval, 'month') %></td>
        <td>
          <%= link_to subscription.last_order.number, edit_admin_order_path(subscription.last_order), target: '_blank' %>
          <br />
          <%= l(subscription.last_order.completed_at, format: :long)  %>
          <br />
          <%= link_to(subscription.user.email, edit_admin_user_path(subscription.user), target: '_blank') if subscription.user %>
          <br />
          <%= subscription.shipping_method.name %>
        </td>
        <td>
          <span class="state <%= subscription.orders.first.state.downcase %>"><%= Spree.t("order_state.#{subscription.orders.first.state.downcase}") %></span>          
        <td class="align-center">
          <%= subscription.skip_order_at.nil? ? 'No' : 'Yes' unless subscription.cancelled? %>
        </td>
        <td class="align-center">
          <%= subscription.next_shipment_date.strftime '%a, %b %d, %Y' unless subscription.cancelled? %>
        </td>
        <td class="align-center">
          <%= subscription.estimated_arrival_date.strftime '%a, %b %d, %Y' unless subscription.cancelled? %>
        </td>
        <td class="align-center"><%= l(subscription.cancelled_at, format: :long) if subscription.cancelled_at %></td>
        <td class='actions align-center' data-hook="admin_subscriptions_index_row_actions">
          <%=
            unless subscription.cancelled?
            link_to_with_icon 'refresh', 'Renew', renew_admin_subscription_path(subscription), no_text: true, data: { confirm: 'Are you sure you want to renew the subscription?' }
            end
          -%>
          <%=          
            link_to_with_icon 'edit', 'Edit', edit_admin_subscription_path(subscription), no_text: true
          -%>
          <%=
            unless subscription.cancelled?
              link_to_with_icon 'cancel', 'Cancel', cancel_admin_subscription_path(subscription),
                no_text: true, data: { confirm: t(:are_you_sure), action: 'remove' }
            end
          -%>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>
<% else %>
  <div class="no-objects-found">
    <%= t(:no_subscriptions_found)%>
  </div>
<% end %>

<%= paginate @subscriptions %>
